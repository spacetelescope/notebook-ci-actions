name: Notebook Execution with Fallback

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string

jobs:
  # Job 1: Discover all notebooks and output a matrix (each object contains the key "notebook")
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate matrix from notebooks/
        id: set-matrix
        run: |
          # Find all .ipynb files under notebooks/ and create a JSON array of objects
          matrix=$(find notebooks -type f -name "*.ipynb" | jq -R -s -c 'split("\n") | map(select(length > 0) | { notebook: . })')
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  # Job 2: Run each notebook on the default runner (ubuntu-latest)
  run-notebook:
    needs: generate-matrix
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install notebook dependencies
        run: |
          nb_dir=$(dirname "${{ matrix.notebook }}")
          if [ -f "$nb_dir/requirements.txt" ]; then
            echo "Installing requirements from $nb_dir/requirements.txt"
            pip install -r "$nb_dir/requirements.txt"
          else
            echo "No requirements.txt found in $nb_dir, skipping dependency install."
          fi

      - name: Execute notebook with resource monitoring
        env:
          NOTEBOOK: ${{ matrix.notebook }}
        run: |
          # Start an inline monitor in the background that kills nbconvert if memory or disk usage >80%
          NB_CONVERT_PID=0
          monitor() {
            while sleep 5; do
              # Calculate memory usage as a percentage (this may vary by distro)
              mem_usage=$(free | awk '/^Mem/ {printf "%.0f", $3/$2 * 100}')
              # Get disk usage for the root filesystem (assumes '/' is the relevant mount)
              disk_usage=$(df / | tail -1 | awk '{print $5}' | tr -d '%')
              if [ "$mem_usage" -gt 80 ] || [ "$disk_usage" -gt 80 ]; then
                echo "Resource usage exceeded threshold (Mem: ${mem_usage}%, Disk: ${disk_usage}%). Killing nbconvert (PID: $NB_CONVERT_PID)"
                kill -9 $NB_CONVERT_PID || true
              fi
            done
          }
          monitor &
          MONITOR_PID=$!
          echo "Monitor started (PID: $MONITOR_PID)"
          
          # Execute the notebook with nbconvert in the background and capture its PID
          python -m nbconvert --to notebook --execute "$NOTEBOOK" --output executed.ipynb &
          NB_CONVERT_PID=$!
          echo "Started nbconvert (PID: $NB_CONVERT_PID) for notebook: $NOTEBOOK"
          
          # Wait for nbconvert to finish
          wait $NB_CONVERT_PID
          RESULT=$?
          
          # Kill the monitor process
          kill $MONITOR_PID || true
          
          exit $RESULT

      - name: Archive executed notebook
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: executed-notebook-${{ matrix.notebook }}
          path: executed.ipynb

  # Job 3: Fallback â€“ re-run notebooks on an alternate runner if the primary run fails
  fallback-run:
    needs: run-notebook
    if: ${{ failure() }}
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false
    runs-on: jwst-pipeline-notebooks-16gb
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python ${{ inputs.python-version }} (Fallback)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install notebook dependencies (Fallback)
        run: |
          nb_dir=$(dirname "${{ matrix.notebook }}")
          if [ -f "$nb_dir/requirements.txt" ]; then
            echo "Installing requirements from $nb_dir/requirements.txt"
            pip install -r "$nb_dir/requirements.txt"
          else
            echo "No requirements.txt found in $nb_dir, skipping dependency install."
          fi

      - name: Execute notebook with resource monitoring (Fallback)
        env:
          NOTEBOOK: ${{ matrix.notebook }}
        run: |
          NB_CONVERT_PID=0
          monitor() {
            while sleep 5; do
              mem_usage=$(free | awk '/^Mem/ {printf "%.0f", $3/$2 * 100}')
              disk_usage=$(df / | tail -1 | awk '{print $5}' | tr -d '%')
              if [ "$mem_usage" -gt 80 ] || [ "$disk_usage" -gt 80 ]; then
                echo "Resource usage exceeded threshold (Mem: ${mem_usage}%, Disk: ${disk_usage}%). Killing nbconvert (PID: $NB_CONVERT_PID)"
                kill -9 $NB_CONVERT_PID || true
              fi
            done
          }
          monitor &
          MONITOR_PID=$!
          echo "Monitor started (PID: $MONITOR_PID)"
          
          python -m nbconvert --to notebook --execute "$NOTEBOOK" --output executed.ipynb &
          NB_CONVERT_PID=$!
          echo "Started nbconvert (PID: $NB_CONVERT_PID) for notebook: $NOTEBOOK"
          
          wait $NB_CONVERT_PID
          RESULT=$?
          
          kill $MONITOR_PID || true
          
          exit $RESULT

      - name: Archive executed notebook (Fallback)
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: executed-notebook-fallback-${{ matrix.notebook }}
          path: executed.ipynb
